function SysShell(shellspace){BaseObject.apply(this,arguments);if(shellspace!=null){if(shellspace.jquery!=null){if(shellspace.length>0){this.root=shellspace.get(0);}}else{this.root=shellspace;}}else{this.root=System.Default().getWorkspaceElement();}this.$dispatcherLeasing=new EventDispatchLeasing("IAppBase");$(document).bind("keydown",Delegate.createWrapper(this,this.$sysKeyBindings));System.Default().windowunloadevent.add(new Delegate(this,this.shutdown));this.shellLocalApi=new ShellLocalApi(this);LocalAPI.Default().registerAPI(IShellApi,this.shellLocalApi);}SysShell.Inherit(BaseObject,"SysShell");SysShell.Implement(IAjaxContextParameters);SysShell.Implement(IStructuralQueryProcessorImpl);SysShell.Implement(IDOMConnectedObject);SysShell.Implement(IStructuralQueryRouterImpl,"sysshell",function(){return null;});SysShell.prototype.$customizers=new InitializeObject("All the customizers.");SysShell.prototype.addCustomizer=function(iface,cust){var iface_name=Class.getInterfaceName(iface);if(iface_name==null||cust==null)return;var IShellCustomizer=Interface("IShellCustomizer");if(BaseObject.is(cust,iface)&&Class.doesextend(iface,IShellCustomizer)){this.$customizers[iface_name]=cust;cust.set_shell(this);cust.set_workspacewindow(this.get_workspacewindow());var op=cust.initialize();if(!BaseObject.is(op,"Operation")){return Operation.From(op);}return op;}else{throw"Failed to add the shell customizer "+(cust!=null?cust.classType():"null")+", because it is not based on IShellCustomizer interface";}};SysShell.prototype.removeCustomizer=function(iface){var iface_name=Class.getInterfaceName(iface);if(iface_name!=null){delete this.$customizers[iface_name];}};SysShell.prototype.getCustomizer=function(iface){var iface_name=Class.getInterfaceName(iface);if(iface_name!=null){return this.$customizers[iface_name];}return null;};SysShell.prototype.shellLocalApi=null;SysShell.prototype.get_localajaxcontextparameter=function(param){if(this.$ajaxcontextparameter!=null&&this.$ajaxcontextparameter[""+param]!=null)return this.$ajaxcontextparameter[""+param];return null;};SysShell.prototype.get_ajaxcontextparameter=function(param){var result=this.get_localajaxcontextparameter(param);if(result!=null)return result;return null;};SysShell.prototype.set_localajaxcontextparameter=function(param,v){if(this.$ajaxcontextparameter==null)this.$ajaxcontextparameter={};this.$ajaxcontextparameter[""+param]=v;};SysShell.prototype.$isFinalAuthority=true;SysShell.prototype.isFinalAuthority=function(param){return this.$isFinalAuthority;};SysShell.prototype.workspaceWindow=null;SysShell.prototype.get_workspacewindow=function(){return this.workspaceWindow;};SysShell.prototype.get_connecteddomelement=function(key){var w=this.get_workspacewindow();if(BaseObject.is(w,"Base")){return w.root;}};SysShell.prototype.shutdown=function(sys,e){this.killAll();};SysShell.ImplementIndexedProperty("runningapps",new InitializeArray("The running apps register"));SysShell.prototype.getAppByInstanceId=function(id){var apps=this.get_runningapps();if(BaseObject.is(apps,"Array")){return apps.FirstOrDefault(function(idx,app){if(app.get_instanceid()==id){return app;}return null;});}return null;}.Returns("app if the id exists");SysShell.prototype.getAppsByInstanceName=function(name){var apps=this.get_runningapps();if(BaseObject.is(apps,"Array")){return apps.Select(function(idx,app){if(app.get_instancename()==name){return app;}return null;});}return null;};SysShell.prototype.getAppsByFilter=function(callback){var apps=this.get_runningapps();if(BaseObject.is(apps,"Array")){if(BaseObject.isCallback(callback)){return apps.Select(function(idx,app){if(BaseObject.callCallback(callback,app)){return app;}return null;});}else{return Array.createCopyOf(apps);}}return null;};SysShell.prototype.getAppsByClassNames=function(clsNames){var classes=Array.createCopyOf(arguments);if(classes.length>0){return this.getAppsByFilter(function(app){if(!BaseObject.is(app,"IAppBase"))return false;return classes.FirstOrDefault(function(idx,item){if(app.is(item))return item;return null;})!=null;});}return null;};SysShell.prototype.getAppByClassName=function(clsName){var apps=this.get_runningapps();if(BaseObject.is(apps,"Array")){return apps.FirstOrDefault(function(idx,app){if(BaseObject.is(app,clsName)){return app;}return null;});}return null;};SysShell.prototype.getAppWindows=function(appinst){var ws=this.get_workspacewindow();if(BaseObject.is(ws,"BaseWindow")){return ws.children.Select(function(idx,wnd){if(BaseObject.is(ws,"IAppElement")){if(wnd.get_approot()==appinst){return wnd;}}return null;});}return null;};SysShell.prototype.activateApp=function(appinst){if(!BaseObject.is(appinst,"IApp"))return false;var bDone=false;if(appinst!=null){var wnds=this.getAppWindows(appinst);if(BaseObject.is(wnds,"Array")){wnds.Each(function(idx,wnd){bDone=true;wnd.setWindowStyles(WindowStyleFlags.visible,"set");wnd.activateWindow();});}}return bDone;};SysShell.prototype.$dispatcherLeasing=null;SysShell.prototype.launch=function(_appClass,appArgs){var arr=[_appClass,{}];return this.launchEx.apply(this,arr.concat(Array.createCopyOf(arguments,1)));};SysShell.prototype.launchOne=function(_appClass,appArgs){var arr=[_appClass,{oneinstance:true}];return this.launchEx.apply(this,arr.concat(Array.createCopyOf(arguments,1)));};SysShell.prototype.$launchExActive=false;SysShell.prototype.$launchQueue=new InitializeArray("Launch requests");SysShell.prototype.launchEx=function(){var args=Array.createCopyOf(arguments);var op=new Operation(null,30000);this.$launchQueue.push({args:args,operation:op});if(!this.$launchExActive){this.$pickLaunchQueue();}return op;};SysShell.prototype.$pickLaunchQueue=function(){var me=this;this.$launchExActive=true;if(this.$launchQueue!=null&&this.$launchQueue.length>0){var entry=this.$launchQueue.pop();if(entry!=null){this.$launchEx.apply(this,entry.args).then(function(){me.$launchExActive=true;me.callAsync(me.$pickLaunchQueue);}).transfer(entry.operation);return;}}this.$launchExActive=false;};SysShell.prototype.$launchEx=function(_appClass,_options,appArgs){var _shell=this;var options=_options||{};var op=new Operation(null,20000);var apiHubs=[LocalAPI.Default()];var apiHubsServe=[LocalAPI.Default()];var app=null;var appClass=Class.getClassDef(_appClass);if(appClass==null){op.CompleteOperation(false,"SysShell::launch: The appClass is not found : "+appClass);return op;}var args=Array.createCopyOf(arguments,2);var clean_args=Array.createCopyOf(arguments,2);if(this.workspaceWindow!=null){if(Class.is(appClass,"IOneInstanceApp")||options.oneinstance){var oldInst=null;if(appClass){oldInst=this.getAppByClassName(appClass.classType);}if(oldInst!=null){if(BaseObject.is(oldInst,"IOneInstanceApp")){if(oldInst.get_autoactivate()){this.activateApp(oldInst);}var opOld=oldInst.newLaunchRequest.apply(oldInst,args);if(BaseObject.is(opOld,"Operation")){opOld.whencomplete().complete(op,oldInst);}else{op.CompleteOperation(true,oldInst);}return op;}else{if(args.length>0){op.CompleteOperation(false,"You attempt to start an one instance app with arguments, but it does not support IOneInstanceApp and the arguments cannot be passed to the running instance");}else{this.activateApp(oldInst);op.CompleteOperation(true,oldInst);}return op;}}}if(!Class.is(appClass,"IApp")){jbTrace.log("SysShell::launch: The appClass is not registered or does not support IApp: "+appClass);op.CompleteOperation(false,"SysShell::launch: The appClass is not registered or does not support IApp : "+appClass);return op;}prepareAPIHubs();var app,appgate,querybackiface;if(Class.is(appClass,"IRequiresQueryBack")){querybackiface=new SysShellQueryBack(this,appClass);app=new appClass(querybackiface);}else{appgate=new AppGate(this,createLocalAPIClient(),appClass,apiHubsServe.length>0?apiHubsServe[0]:null);app=new appClass(appgate);}var shuttingdownOp=null;function displaceNotify(msg){if(lastPlacedWindow==msg.target)lastPlacedWindow=null;msg.target.unregisterExternalHandler("Close",displaceNotify);app.windowDisplaced(msg.target);};function shutdownapp(){if(shuttingdownOp!=null){return shuttingdownOp;}var sop=new Operation();shuttingdownOp=sop;exposeLocalAPIs(true);if(_shell.shellLocalApi)_shell.shellLocalApi.appstop.invoke(app.$__instanceId,appClass);Messenger.Instance().post(new AppStartStopMessage(app,AppStartStopEventEnum.stop));var shutdownsuccess=app.appshutdown.call(app,function(success){if(appgate!=null){appgate.releaseAll();appgate.revokeAllLocalAPI();}_shell.$dispatcherLeasing.clearInst(app);_shell.get_runningapps().removeElement(app);sop.CompleteOperation(true,null);});if(shutdownsuccess===false){if(appgate!=null){appgate.releaseAll();appgate.revokeAllLocalAPI();}_shell.$dispatcherLeasing.clearInst(app);_shell.get_runningapps().removeElement(app);sop.CompleteOperation(false,"The app reported shutdown failure.");}else if(shutdownsuccess===true){if(appgate!=null){appgate.releaseAll();appgate.revokeAllLocalAPI();}_shell.$dispatcherLeasing.clearInst(app);_shell.get_runningapps().removeElement(app);sop.CompleteOperation(true,null);}return sop;}function prepareAPIHubs(){var i,arr=null;if(BaseObject.is(options.PriorityLocalAPI,"LocalAPI")){arr=[options.PriorityLocalAPI];}else if(BaseObject.is(options.PriorityLocalAPI,"Array")){arr=options.PriorityLocalAPI;}if(arr!=null&&arr.length>0){for(i=0;i<arr.length;i++){if(BaseObject.is(arr[i],"LocalAPI")){apiHubs.unshift(arr[i]);}}}arr=null;if(BaseObject.is(options.AdditionalLocalAPI,"LocalAPI")){arr=[options.AdditionalLocalAPI];}else if(BaseObject.is(options.AdditionalLocalAPI,"Array")){arr=options.AdditionalLocalAPI;}if(arr!=null&&arr.length>0){for(i=0;i<arr.length;i++){if(BaseObject.is(arr[i],"LocalAPI")){apiHubs.push(arr[i]);}}}if(BaseObject.is(options.RegisterInLocalAPIHub,"LocalAPI")){apiHubsServe=[options.RegisterInLocalAPIHub];}}function exposeLocalAPIs(reg_unreg){var i;if(app.is("IImplementsLocalAPI")){for(i=0;i<apiHubsServe.length;i++){if(!reg_unreg){app.registerLocalAPI(apiHubsServe[i]);}else{app.revokeLocalAPI(apiHubsServe[i]);}}}}function plugLocalAPIs(){if(app.is("IUsingLocalAPI")){var lapiclient=new LocalAPIClient(app.getLocalAPIImportDefinition(),apiHubs);app.setLocalAPIClient(lapiclient);}}function createLocalAPIClient(){var idata=Class.interfaceDataOf(appClass,ILocalAPIImports);var importTable=null;if(idata!=null)importTable=idata.get();return new LocalAPIClient(importTable,apiHubs);}args.unshift(function(result){if(result){_shell.get_runningapps().addElement(app);app.set_instanceid(app.$__instanceId);args.shift();exposeLocalAPIs();op.CompleteOperation(true,app);app.run.apply(app,args);if(_shell.shellLocalApi)_shell.shellLocalApi.appstart.invoke(app.$__instanceId,appClass);Messenger.Instance().post(new AppStartStopMessage(app,AppStartStopEventEnum.start));}else{op.CompleteOperation(false,"Application failed to initialize properly.");shutdownapp();}});var lastPlacedWindow=null;app.get_approotwindow=function(){return lastPlacedWindow;};app.placeWindow=function(w,options){if(BaseObject.is(w,"BaseWindow")){w.set_approot(app);var cust=_shell.getCustomizer("IShellCustomizerPlacer");if(cust!=null){cust.placeWindow(w,options);}else{if(options!=null&&options.role=="shell"){if(typeof options.position=="string"){_shell.workspaceWindow.addChild(w,options.position);}}else{_shell.workspaceWindow.addChild(w);}}if(lastPlacedWindow==null){lastPlacedWindow=w;}w.registerExternalHandler("Close",displaceNotify);w.updateTargets();w.activateWindow();_shell.workspaceWindow.updateTargets();return true;}else{return false;}};app.displaceWindow=function(w,options){if(BaseObject.is(w,"BaseWindow")){w.unregisterExternalHandler("Close",displaceNotify);_shell.workspaceWindow.removeChild(w);return true;}else{return false;}};app.ExitApp=function(){return shutdownapp();};plugLocalAPIs();var syncinitsuccess=app.appinitialize.apply(app,args);if(syncinitsuccess===true){_shell.get_runningapps().addElement(app);app.set_instanceid(app.$__instanceId);args.shift();exposeLocalAPIs();op.CompleteOperation(true,app);app.run.apply(app,args);if(_shell.shellLocalApi)_shell.shellLocalApi.appstart.invoke(app.$__instanceId,appClass);Messenger.Instance().post(new AppStartStopMessage(app,AppStartStopEventEnum.start));}else if(syncinitsuccess===false){op.CompleteOperation(false,app);shutdownapp();}}else{throw"Workspace window does not exist. Make sure you start UI applications after it is created.";}return op;};SysShell.prototype.createStdAppWindow=function(_cls,_template,_persister){var cls=_cls||"MainWindow";var template=BaseObject.is(_template,"Connector")?_template:null;var persister=_persister;var wnd=new Function.classes[cls](persister,WindowStyleFlags.draggable|WindowStyleFlags.sizable|WindowStyleFlags.adjustclient|WindowStyleFlags.visible,template,{on_Destroy:function(){if(persister!=null){persister.save();}}});return wnd;}.Description("Creates typical app main window (MainWindow) with its default template. Using the optional parameters the window class and template can be overwritten. Set unused parameters to null.").Param("_cls","Window class name.Default: MainWindow").Param("_template","Connector to custom window template. By default the default template of MainWindow is used").Param("_persister","A persister for the window state - none by default").Remarks("flags","The window is created with draggable, sizable, adjustclient and visible flags.");SysShell.prototype.shutdownApp=function(appid){var app=this.get_runningapps().FirstOrDefault(function(idx,item){if(item.get_instanceid()==appid)return item;return null;});if(app!=null){return app.ExitApp();}return Operation.From(null);};SysShell.prototype.killAll=function(){var app,apps=this.get_runningapps();if(BaseObject.is(apps,"Array")){for(var i=apps.length-1;i>=0;i--){app=apps[i];if(BaseObject.is(app,"IApp")){app.appshutdown();}}}};SysShell.prototype.addAppWindow=function(w,options){if(this.workspaceWindow!=null){if(BaseObject.is(w,"BaseWindow")){w.set_windowparent(this.workspaceWindow);w.setWindowStyles(WindowStyleFlags.draggable|WindowStyleFlags.visible,"set");}else{jbTrace.log("SysShell::addAppWindow: The passed object is null or not a window.");}}};SysShell.$traceconsoleview='<div data-class="jbTrace" data-key="dbgRoot" style="height:100%;padding:0px;overflow-y:scroll;">'+'<pre data-key="logview" data-class="Repeater" data-bind-$items="{read}" style="margin:0px;height:100%;" data-on-dblclick="{bind source=dbgRoot path=OnClear}">'+'<div class="dbgEntry" data-bind-html="{read path=msg}" data-bind-jbtracecolor="{read path=msgtype}"></div>'+'</pre>'+'</div>';SysShell.prototype.console=null;SysShell.prototype.showConsole=function(){if(this.console!=null&&this.console.get_destroyedwindow())this.console=null;if(this.console==null){var tmlconn=new RegisterTemplateConnector('bindkraftworkspace/window-mainwindow-app','module_templates');if(this.workspaceWindow!=null){this.console=new SimpleViewWindow(this.workspaceWindow,{caption:"Trace console"},WindowStyleFlags.draggable|WindowStyleFlags.sizable|WindowStyleFlags.visible|WindowStyleFlags.adjustclient,tmlconn);}else{this.console=new SimpleViewWindow({caption:"Trace console"},WindowStyleFlags.draggable|WindowStyleFlags.sizable|WindowStyleFlags.visible|WindowStyleFlags.adjustclient,tmlconn);this.console.attachInDOM($("body"));}this.console.LoadView({view:SysShell.$traceconsoleview,directData:{}});this.console.set_windowrect(new Rect(10,10,500,400));}else{this.console.activateWindow();}};SysShell.prototype.openAppWindow=function(className,params,closure){if(this.workspaceWindow!=null){if(Class.is(Function.classes[className],"BaseWindow")){var tmlconn=new RegisterTemplateConnector('bindkraftworkspace/window-mainwindow-app','module_templates');var w=new Function.classes[className](persister,this.workspaceWindow,WindowStyleFlags.draggable|WindowStyleFlags.sizable|WindowStyleFlags.adjustclient,tmlconn,{on_Create:new Delegate(this,this.onAViewHasBeenLoaded),launchParameters:params},closure);}else{jbTrace.log("SysShell::openAppWindow: The className is not registered or is not a CWindoBase derived");}}};SysShell.prototype.openWindowedView=function(viewParams,in_closure_or_rect){var closure=Array.createCopyOf(arguments,1).FirstOrDefault(function(idx,itm){if(typeof itm=="function"||BaseObject.is(itm,"Delegate"))return itm;return null;});var rect=Array.createCopyOf(arguments,1).FirstOrDefault(function(idx,itm){if(BaseObject.is(itm,"Rect"))return itm;return null;});if(this.workspaceWindow!=null){var w=new SimpleViewWindow(this.workspaceWindow,WindowStyleFlags.draggable|WindowStyleFlags.sizable|WindowStyleFlags.adjustclient,new TemplateConnector('bindkraftworkspace/window-mainwindow-app'),BaseObject.CombineObjects(viewParams,{on_Create:new Delegate(this,this.onAViewHasBeenLoaded)}),closure,rect);if(rect!=null){this.callAsync(function(){w.set_windowrect(rect);});}}};SysShell.prototype.openView=function(url,data,callback){var _url,_data,_callback;if(typeof url=="object"){_url=url.url;_data=url.data;_callback=url.callback;}else{_url=url;_data=data;_callback=callback;}var params={url:_url,data:_data};this.openWindowedView({url:url,data:data},_callback);};SysShell.prototype.$poscycler=0;SysShell.prototype.onAViewHasBeenLoaded=function(msg){var rect=this.workspaceWindow.get_windowrect();rect.x=rect.x+rect.w*this.$poscycler/32;rect.y=rect.y+rect.h*this.$poscycler/32;rect.w=rect.w*3/4;rect.h=rect.h*3/4;msg.target.set_windowrect(rect);msg.target.setWindowStyles(WindowStyleFlags.visible,"set");WindowingMessage.fireOn(msg.target,WindowEventEnum.ActivateWindow,{});this.$poscycler++;if(this.$poscycler>7)this.$poscycler=0;};SysShell.prototype.get_initialized=function(){if(this.root!=null)return true;return false;};SysShell.prototype.$sysKeyBindings=function(e){if(e.ctrlKey&&e.altKey){var fs=System.GetFS("shellfs");var ch=String.fromCharCode(e.which);var shk=fs.item("keylaunch/"+ch);if(shk!=null){var op=Commander.RunGlobal(shk.get_script());op.whencomplete().tell(function(_op){if(!_op.isOperationSuccessful()){console.log("Error executing shortcut"+ch);}});}}};SysShell.MessageBox=function(message,title,callback,okBtn,cancelBtn,yesBtn,noBtn){};SysShell.Alert=function(message,modaltitle,view,callback){var initDialog={url:"sbin/confirmdialog.asp",viewName:"normal",dialogHeight:200,dialogWidth:500,modal:true,resizable:false,title:"Warning",directData:true,view:view,data:{title:message,caption:modaltitle||"Warning",titleOK:"OK",titleCancel:"Cancel",isCancelVisible:false}};return Shell.confirmDialog(initDialog,callback);};