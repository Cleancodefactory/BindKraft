(function(){function Localization(appClass,lang){BaseObject.apply(this,arguments);if(typeof appClass=="function"){appClass=Class.getTypeName(appClass);}if(typeof appClass=="string"&&(appClass=="system"||Class.getClassName(appClass)!=null)){this.$appClass=appClass;}else{throw"Localization can be created only for a specific class or the system. The class should be preferably an app class if at all possible.";}var memfs=Registers.Default().getRegister("appfs");if(!BaseObject.is(memfs,"MemoryFSDirectory"))throw"Cannot find the appfs: file system. Check if system/sysconfig.js is not corrupted.";var dir=memfs.cd(appClass);if(dir==null)throw"App directory does not exist in appfs: for "+appClass;var locdir=dir.cd("localization");if(!BaseObject.is(locdir,"MemoryFSDirectory"))throw"Cannot find the localization directory for "+appClass;this.$dir=locdir;this.$lang=lang||System.Default().settings.CurrentLang;}Localization.Inherit(BaseObject,"Localization");Localization.truncateLocaleTag=function(locale){if(typeof locale=="string"){var arr=locale.split("-");if(arr.length>0){if(arr[arr.length-1].length>=1){arr.pop();}for(var i=arr.length-1;i>=0;i--){if(arr[i].length==1){arr.pop();break;}}if(arr.length>0){return arr.join("-");}}}return null;};Localization.findClosestSuitableLocale=function(locale,availableLocales,bUltimate){if(!BaseObject.is(availableLocales,"Array")||availableLocales.length==0)return bUltimate?System.Default().get_settings("UltimateFallBackLocale"):null;var al=availableLocales.Select(function(idx,l){return l.toLowerCase();});while(locale!=null&&al.indexOf(locale)<0){locale=this.truncateLocaleTag(locale);}if(locale==null)bUltimate?System.Default().get_settings("UltimateFallBackLocale"):null;return locale;};Localization.prototype.$appClass=null;Localization.prototype.$lang=null;Localization.prototype.$dir=null;Localization.prototype.$loadTranslation=function(locale){var f=this.$dir.item("translations/"+locale);if(BaseObject.is(f,"IMemoryFileContent")){return f.get_content();}return null;};Localization.$translations={};Localization.prototype.$loadTranslationLocale=function(_locale){var locale=_locale||this.$lang;var arrTrans=[];var t;var $translations=this.get_translations();var xlocale=locale;while(xlocale!=null){t=this.$loadTranslation(xlocale);if(t!=null)arrTrans.unshift(t);xlocale=Localization.truncateLocaleTag(xlocale);}if(arrTrans.length>0){t=BaseObject.CombineObjects.apply(null,arrTrans);$translations[locale]=t;return t;}return null;};Localization.prototype.get_culture=function(){return this.$lang;};Localization.prototype.get_translations=function(){if(Localization.$translations[this.$appClass]==null){Localization.$translations[this.$appClass]={};}return Localization.$translations[this.$appClass];};Localization.get_translations=function(appClass){if(Localization.$translations[appClass]==null){Localization.$translations[appClass]={};}return Localization.$translations[appClass];};Localization.prototype.get_translation=function(_locale){var locale=_locale||this.$lang;if(typeof locale!="string"||!/^\w{2}(-.*)?$/.test(locale)){this.LASTERROR(_Errors.compose(),"Invalid locale","get_translation");return null;}var $translations=this.get_translations();var loc=$translations[locale];if(loc==null){loc=this.$loadTranslationLocale(locale);}if(loc==null){loc=this.get_translation(System.Default().get_settings("UltimateFallBackLocale"));}return loc;};Localization.get_translation=function(appClass,_locale){var locale=_locale||System.Default().get_settings("CurrentLang");if(typeof locale!="string"||!/^\w{2}(-.*)?$/.test(locale)){return null;}var $translations=Localization.get_translations(appClass);var loc=$translations[locale];if(loc==null){var l=new Localization(appClass);loc=l.$loadTranslationLocale(locale);}if(loc==null&&locale!=System.Default().get_settings("UltimateFallBackLocale")){loc=Localization.get_translation(appClass,System.Default().get_settings("UltimateFallBackLocale"));}return loc;};})();