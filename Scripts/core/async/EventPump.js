function EventPump(config){BaseObject.apply(this,arguments);this.config={messagesPerTick:2};this.$schedulerId=EventPump.$schedulerIdCurrent!=null?EventPump.$schedulerIdCurrent++:EventPump.$schedulerIdCurrent=0;this.$taskIdCurrent=0;if(typeof config=="object")this.config=BaseObject.CombineObjects(this.config,config);}EventPump.Inherit(BaseObject,"EventPump");EventPump.Implement(ITickable);EventPump.Implement(IProcessScheduler);EventPump.prototype.equals=function(obj){if(!BaseObject.prototype.equals.call(this,obj))return false;if(this!=obj)return false;return true;};EventPump.prototype.queue=new InitializeArray("Message queue");EventPump.prototype.post=function(msg,condition,maxAge,after){var target=null;if(BaseObject.is(msg,"ITargeted")){target=msg.get_target();}this.queue.push({message:msg,condition:condition,after:after,maxAge:maxAge,postedAt:new Date().getTime(),target:target});this.register();};EventPump.prototype.trackPost=function(msg,chainResult,condition,maxAge,after){var ar=null;var target=null;if(BaseObject.is(msg,"IAsyncResult")){ar=msg;if(msg.is("ITargeted"))target=msg.get_target();ar.set_scheduler(this);this.queue.push({message:null,condition:condition,after:after,maxAge:maxAge,postedAt:new Date().getTime(),asyncResult:ar,target:target});ar.set_scheduled(true);}else if(BaseObject.is(msg,"IDispatchable")){ar=new AsyncResult(this,msg);if(msg.is("ITargeted"))target=msg.get_target();this.queue.push({message:msg,condition:condition,after:after,maxAge:maxAge,postedAt:new Date().getTime(),asyncResult:ar,target:target});ar.set_scheduled(true);}else if(BaseObject.is(msg,"Delegate")){var disp=new Dispatchable(msg);target=msg.object;ar=new AsyncResult(this,disp);this.queue.push({message:disp,condition:condition,after:after,maxAge:maxAge,postedAt:new Date().getTime(),asyncResult:ar,target:target});ar.set_scheduled(true);}else if(typeof msg=="function"){var disp=new Dispatchable(Delegate.createWrapper(null,msg));ar=new AsyncResult(this,disp);this.queue.push({message:disp,condition:condition,after:after,maxAge:maxAge,postedAt:new Date().getTime(),asyncResult:ar,target:null});ar.set_scheduled(true);}else{throw"trackPost has been called with some invalid arguments";}if(ar!=null){if(BaseObject.is(chainResult,"IAsyncResult")){chainResult.chainResult(ar);}}this.register();return ar;};EventPump.prototype.$pick=function(){if(this.queue.length>0){var o=this.queue.shift();if(typeof o.after=="number"&&(o.$waiting==null||o.$waiting<o.after)){if(o.$waiting==null){o.$waiting=Ticker.Default.timeout;}else{o.$waiting+=Ticker.Default.timeout;}this.queue.push(o);return false;}if(typeof o.maxAge=="number"&&new Date().getTime()-o.postedAt>o.maxAge){return false;}if(o.condition!=null){if(BaseObject.callCallback(o.condition,o.message)){return o;}else{this.queue.push(o);return false;}}else{if(o!=null)return o;}}return false;}.Description("Picks a message holder. See pick for more info.");EventPump.prototype.pick=function(){var h=this.$pick();if(h===false)return false;if(h!=null)return h.message;return null;}.Description("Picks a message if it has no condition or if its condition resolves to true, if thecondition is not met requeues the message at the end of the queue and returns null. Returns false if the queue is empty");EventPump.prototype.register=function(){if(this.queue.length>0&&this.$enabled){Ticker.Default.add(this);Ticker.Default.start();}else{Ticker.Default.remove(this);}}.Description("Registers/unregisters the pump with the Ticker as needed - if there are messages.");EventPump.prototype.$enabled=true;EventPump.prototype.enable=function(bEnabled){this.$enabled=bEnabled;this.register();};EventPump.prototype.$internalProcessMessage=function(ticker,h){if(h!=null){var msg=null;var ar=BaseObject.as(h.asyncResult,"IAsyncResult");if(BaseObject.is(h.message,"IDispatchable")){msg=h.message;}else if(h.message==null&&ar!=null){msg=ar.get_task();}this.$currentAsyncResult=h.asyncResult;CallContext.rootContext();if(ar!=null)ar.$set_executing(true);if(msg!=null)msg.dispatch(ar);if(ar!=null)ar.$set_executing(false);CallContext.endContext();this.$currentAsyncResult=null;if(h.asyncResult!=null){if(BaseObject.is(msg,"IDataHolder")){h.asyncResult.setComplete(msg.get_data());}else{h.asyncResult.setComplete();}}}};EventPump.prototype.tick=function(ticker){if(!this.$enabled)return;var h,notdone=true;for(var i=0;i<this.config.messagesPerTick;i++){do{h=this.$pick();if(h===false){notdone=false;this.register();continue;}if(h!=null){if(BaseObject.is(h.asyncResult,"IAsyncResult")){if(h.asyncResult.scheduleOptions!=null&&(h.asyncResult.scheduleOptions&ProcessScheduleOptionsEnum.Later)!=0){h.asyncResult.scheduleOptions&=0xFFFF^ProcessScheduleOptionsEnum.Later;this.queue.push(h);continue;}}this.$internalProcessMessage(ticker,h);notdone=false;if(BaseObject.is(h.asyncResult,"IAsyncResult")){if(h.asyncResult.scheduleOptions!=null&&(h.asyncResult.scheduleOptions&ProcessScheduleOptionsEnum.Continue)!=0){notdone=true;continue;}}}}while(notdone);}};EventPump.prototype.generateTaskId=function(){return this.$shcedulerId+"_"+this.$taskIdCurrent++;};EventPump.prototype.schedule=function(){return this.trackPost.apply(this,arguments);};EventPump.prototype.unschedule=function(disp_or_result){this.queue.Delete(function(idx,item){if(item!=null&&(item.message==disp_or_result||item.asyncResult==disp_or_result)){if(item.asyncResult!=null)item.asyncResult.set_scheduled(false);return true;}return false;});};EventPump.prototype.unscheduleByTarget=function(target,callback){if(target!=null){this.queue.Delete(function(idx,item){if(item.target==target){if(item.asyncResult!=null)item.asyncResult.set_scheduled(false);return true;}return false;});}else if(target!=null&&callback!=null){this.queue.Delete(function(idx,item){if(item.target==target&&BaseObject.callCallback(item.message,item.asyncResult)){if(item.asyncResult!=null)item.asyncResult.set_scheduled(false);return true;}return false;});}else if(callback!=null){this.queue.Delete(function(idx,item){if(BaseObject.callCallback(item.message,item.asyncResult)){if(item.asyncResult!=null)item.asyncResult.set_scheduled(false);return true;}return false;});}};EventPump.prototype.$currentAsyncResult=null;EventPump.prototype.currentAsyncResult=function(){return this.$currentAsyncResult;};EventPump.$Default=null;EventPump.Default=function(){if(EventPump.$Default==null){EventPump.$Default=new EventPump();}return EventPump.$Default;};